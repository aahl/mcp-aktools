name: Trading with Claude code

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      prompt:
        description: Prompt for Claude code
        default: ''

env:
  TRADING_PROMPT: |
    ä½ æ˜¯ä¸€ä¸ªåŠ å¯†è´§å¸äº¤æ˜“æœºå™¨äººï¼Œä½ éœ€è¦å…ˆæŸ¥çœ‹OKXè´¦æˆ·ä¿¡æ¯ã€ä»“ä½çŠ¶æ€åŠè¿‘æœŸäº¤æ˜“è®°å½•ï¼Œç„¶åŽåˆ†æžè¡Œæƒ…ï¼Œå¹¶æ ¹æ®æŠ•èµ„å»ºè®®åšå‡ºç›¸åº”çš„äº¤æ˜“åŠ¨ä½œã€‚
    ä½ åªèƒ½äº¤æ˜“è¿™äº›äº¤æ˜“å¯¹ï¼šBTC-USDT, ETH-USDT, SOL-USDT, ETH-BTC, SOL-BTC, SOL-ETHã€‚
    å°†åˆ†æžã€æŒä»“ã€äº¤æ˜“ç»“æžœå¹¶æŽ¨é€åˆ° Telegram ä¼šè¯:
    - ä»¥AIæ¨¡æ‹Ÿç›˜è‡ªåŠ¨äº¤æ˜“æŠ¥å‘Šä¸ºæ ‡é¢˜
    - ç¡®ä¿ä¸¥æ ¼éµå¾ªå·¥å…·`tg_markdown_rule`æä¾›çš„Markdownæ ¼å¼
    - é™¤äº†markdownè¯­æ³•å¤–ï¼Œ`-`/`.`ç­‰éƒ½å¿…é¡»è¦ç”¨`\`è½¬ä¹‰
    - é‡åˆ°æŠ¥é”™`Can't parse entities`æ—¶è½¬çº¯æ–‡æœ¬å‘é€
    ä½¿ç”¨å·¥å…·`save_trading_result`ä¿å­˜ç»“æžœã€‚

jobs:
  trading:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      - name: Set up Python
        run: uv python install

      - name: Create MCP Config
        run: |
          cat > /tmp/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "aktools": {
                "command": "uvx",
                "args": ["mcp-aktools"]
              },
              "okx": {
                "command": "uvx",
                "args": ["mcp-okx"],
                "env": {
                  "OKX_API_KEY": "${{ secrets.OKX_DEMO_API_KEY }}",
                  "OKX_API_SECRET": "${{ secrets.OKX_DEMO_API_SECRET }}",
                  "OKX_PASSPHRASE": "${{ secrets.OKX_DEMO_PASSPHRASE }}",
                  "OKX_TRADE_FLAG": "1"
                }
              },
              "notify": {
                "command": "uvx",
                "args": ["mcp-notify"],
                "env": {
                  "TELEGRAM_DEFAULT_CHAT": "${{ vars.TG_CHAT_MCPBTC }}",
                  "TELEGRAM_BOT_TOKEN": "${{ secrets.TELEGRAM_BOT_TOKEN }}"
                }
              },
              "hooks": {
                "command": "uv",
                "args": [
                  "--directory", "${{ github.workspace }}/trading",
                  "run", "mcp-hooks.py"
                ]
              }
            }
          }
          EOF

      - uses: anthropics/claude-code-action@v1
        timeout-minutes: 30
        env:
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        with:
          prompt: ${{ inputs.prompt || env.TRADING_PROMPT }}
          show_full_output: true
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          claude_args: |
            --mcp-config /tmp/mcp-config.json
            --allowedTools "WebSearch,WebFetch,mcp__aktools,mcp__okx,mcp__notify,mcp__hooks"
          settings: |
            {
              "env": {
                "ANTHROPIC_DEFAULT_OPUS_MODEL": "${{ vars.ANTHROPIC_DEFAULT_OPUS_MODEL }}",
                "ANTHROPIC_DEFAULT_HAIKU_MODEL": "${{ vars.ANTHROPIC_DEFAULT_HAIKU_MODEL }}",
                "ANTHROPIC_DEFAULT_SONNET_MODEL": "${{ vars.ANTHROPIC_DEFAULT_SONNET_MODEL }}"
              },
              "hooks": {
                "PostToolUse": [
                  {
                    "matcher": "*",
                    "hooks": [
                      {
                        "type": "command",
                        "command": "jq -r '\"\\(.tool_input.command)\"' 1>&2"
                      }
                    ]
                  }
                ]
              }
            }

      - name: Commit & Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A trading
          git status
          git commit -m "ðŸ“ˆ AkTools MCP Server"
          git push
