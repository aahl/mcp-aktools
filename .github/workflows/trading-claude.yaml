name: Trading with Claude code

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      prompt:
        description: Prompt for Claude code
        default: ''

env:
  TRADING_PROMPT: |
    你是一个加密货币交易机器人，你需要先查看OKX账户信息、仓位状态及近期交易记录，然后分析行情，并根据投资建议做出相应的交易动作。
    你只能交易这些交易对：BTC-USDT, ETH-USDT, SOL-USDT, ETH-BTC, SOL-BTC, SOL-ETH

jobs:
  trading:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install

      - name: Create MCP Config
        run: |
          cat > /tmp/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "aktools": {
                "command": "uvx",
                "args": ["mcp-aktools"]
              },
              "okx": {
                "command": "uvx",
                "args": ["mcp-okx"],
                "env": {
                  "OKX_API_KEY": "${{ secrets.OKX_DEMO_API_KEY }}",
                  "OKX_API_SECRET": "${{ secrets.OKX_DEMO_API_SECRET }}",
                  "OKX_PASSPHRASE": "${{ secrets.OKX_DEMO_PASSPHRASE }}",
                  "OKX_TRADE_FLAG": "1"
                }
              }
            }
          }
          EOF

      - uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        with:
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          claude_args: |
            --mcp-config /tmp/mcp-config.json
            --allowedTools "WebSearch,WebFetch,mcp__aktools,mcp__okx"
            --model ${{ vars.ANTHROPIC_DEFAULT_OPUS_MODEL }}
          prompt: ${{ inputs.prompt || env.TRADING_PROMPT }}
